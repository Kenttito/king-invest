const nodemailer = require("nodemailer"); const crypto = require("crypto"); require("dotenv").config(); function generateVerificationCode() { return crypto.randomInt(100000, 999999).toString(); } function createTransporter() { const emailConfig = { host: process.env.EMAIL_HOST || "smtp.gmail.com", port: process.env.EMAIL_PORT || 587, secure: false, auth: { user: process.env.EMAIL_USER, pass: process.env.EMAIL_PASS } }; console.log("Email configuration:", { host: emailConfig.host, port: emailConfig.port, user: emailConfig.auth.user, pass: emailConfig.auth.pass ? "***configured***" : "***missing***" }); return nodemailer.createTransport(emailConfig); } async function sendVerificationEmail(email, code) { try { const transporter = createTransporter(); await transporter.verify(); console.log("‚úÖ Email transporter verified successfully"); const mailOptions = { from: process.env.EMAIL_USER, to: email, subject: "Email Verification Code - Kings Invest", html: `<div style="font-family: Arial, sans-serif; max-width: 600px; margin: 0 auto;"><h2 style="color: #333; text-align: center;">Email Verification</h2><p>Thank you for registering with Kings Invest!</p><p>Your verification code is:</p><div style="background-color: #f4f4f4; padding: 20px; text-align: center; margin: 20px 0;"><h1 style="color: #007bff; font-size: 32px; margin: 0; letter-spacing: 5px;">${code}</h1></div><p>This code will expire in 24 hours.</p><p>If you did not request this code, please ignore this email.</p><hr><p style="color: #666; font-size: 12px;">Kings Invest - Secure Investment Platform</p></div>` }; const info = await transporter.sendMail(mailOptions); console.log("‚úÖ Email sent successfully"); console.log("Message ID:", info.messageId); return true; } catch (error) { console.error("‚ùå Email sending failed:", error.message); return false; } } async function testEmailVerification() { const testEmail = process.env.TEST_EMAIL || "test@example.com"; const verificationCode = generateVerificationCode(); console.log("üß™ Testing Email Verification"); console.log("=============================="); console.log("Test email:", testEmail); console.log("Verification code:", verificationCode); console.log(""); console.log("üìã Environment Check:"); console.log("EMAIL_HOST:", process.env.EMAIL_HOST || "smtp.gmail.com (default)"); console.log("EMAIL_PORT:", process.env.EMAIL_PORT || "587 (default)"); console.log("EMAIL_USER:", process.env.EMAIL_USER || "‚ùå NOT SET"); console.log("EMAIL_PASS:", process.env.EMAIL_PASS ? "‚úÖ SET" : "‚ùå NOT SET"); console.log(""); if (!process.env.EMAIL_USER || !process.env.EMAIL_PASS) { console.error("‚ùå Email credentials not configured in .env file"); return; } const success = await sendVerificationEmail(testEmail, verificationCode); if (success) { console.log("üéâ Test completed successfully!"); console.log("Use this code for testing:", verificationCode); } else { console.log("‚ùå Test failed. Check the error messages above."); } } if (require.main === module) { testEmailVerification().catch(console.error); } module.exports = { generateVerificationCode, sendVerificationEmail, testEmailVerification };
